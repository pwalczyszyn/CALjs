//////////////////////////////////////////////////////////////////////////////////////
//
//	Copyright 2012 Piotr Walczyszyn (http://outof.me | @pwalczyszyn)
//
//	Licensed under the Apache License, Version 2.0 (the "License");
//	you may not use this file except in compliance with the License.
//	You may obtain a copy of the License at
//
//		http://www.apache.org/licenses/LICENSE-2.0
//
//	Unless required by applicable law or agreed to in writing, software
//	distributed under the License is distributed on an "AS IS" BASIS,
//	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//	See the License for the specific language governing permissions and
//	limitations under the License.
//
//////////////////////////////////////////////////////////////////////////////////////

/**
 * almond 0.1.1 Copyright (c) 2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*
     * Date Format 1.2.3
     * (c) 2007-2009 Steven Levithan <stevenlevithan.com>
     * MIT license
     *
     * Includes enhancements by Scott Trenda <scott.trenda.net>
     * and Kris Kowal <cixar.com/~kris.kowal/>
     *
     * Accepts a date, a mask, or a date and a mask.
     * Returns a formatted version of the given date.
     * The date defaults to the current date/time.
     * The mask defaults to dateFormat.masks.default.
     */

/**
 * @license RequireJS text 2.0.0 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

(function(root,factory){typeof define=="function"&&define.amd?define(["jquery","require"],factory):root.CalJS=factory(root.jQuery||root.Zepto||root.ender,null,root.iScroll)})(this,function($,_require,iScroll){var requirejs,require,define;return function(undef){function normalize(name,baseName){var baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{},nameParts,nameSegment,mapValue,foundMap,i,j,part;if(name&&name.charAt(0)==="."&&baseName){baseParts=baseParts.slice(0,baseParts.length-1),name=baseParts.concat(name.split("/"));for(i=0;part=name[i];i++)if(part===".")name.splice(i,1),i-=1;else if(part===".."){if(i===1&&(name[2]===".."||name[0]===".."))return!0;i>0&&(name.splice(i-1,2),i-=2)}name=name.join("/")}if((baseParts||starMap)&&map){nameParts=name.split("/");for(i=nameParts.length;i>0;i-=1){nameSegment=nameParts.slice(0,i).join("/");if(baseParts)for(j=baseParts.length;j>0;j-=1){mapValue=map[baseParts.slice(0,j).join("/")];if(mapValue){mapValue=mapValue[nameSegment];if(mapValue){foundMap=mapValue;break}}}foundMap=foundMap||starMap[nameSegment];if(foundMap){nameParts.splice(0,i,foundMap),name=nameParts.join("/");break}}}return name}function makeRequire(relName,forceSync){return function(){return req.apply(undef,aps.call(arguments,0).concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(waiting.hasOwnProperty(name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!defined.hasOwnProperty(name))throw new Error("No "+name);return defined[name]}function makeMap(name,relName){var prefix,plugin,index=name.indexOf("!");return index!==-1?(prefix=normalize(name.slice(0,index),relName),name=name.slice(index+1),plugin=callDep(prefix),plugin&&plugin.normalize?name=plugin.normalize(name,makeNormalize(relName)):name=normalize(name,relName)):name=normalize(name,relName),{f:prefix?prefix+"!"+name:name,n:name,p:plugin}}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var defined={},waiting={},config={},defining={},aps=[].slice,main,req;main=function(name,deps,callback,relName){var args=[],usingExports,cjsModule,depName,ret,map,i;relName=relName||name;if(typeof callback=="function"){deps=!deps.length&&callback.length?["require","exports","module"]:deps;for(i=0;i<deps.length;i++){map=makeMap(deps[i],relName),depName=map.f;if(depName==="require")args[i]=makeRequire(name);else if(depName==="exports")args[i]=defined[name]={},usingExports=!0;else if(depName==="module")cjsModule=args[i]={id:name,uri:"",exports:defined[name],config:makeConfig(name)};else if(defined.hasOwnProperty(depName)||waiting.hasOwnProperty(depName))args[i]=callDep(depName);else if(map.p)map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName];else if(!defining[depName])throw new Error(name+" missing "+depName)}ret=callback.apply(defined[name],args);if(name)if(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name])defined[name]=cjsModule.exports;else if(ret!==undef||!usingExports)defined[name]=ret}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync){return typeof deps=="string"?callDep(makeMap(deps,callback).f):(deps.splice||(config=deps,callback.splice?(deps=callback,callback=relName,relName=null):deps=undef),callback=callback||function(){},forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},15),req)},req.config=function(cfg){return config=cfg,req},define=function(name,deps,callback){deps.splice||(callback=deps,deps=[]),waiting[name]=[name,deps,callback]},define.amd={jQuery:!0}}(),define("almond",function(){}),define("EventDispatcher",[],function(){var EventDispatcher=function(){this.handlersMap={}};return EventDispatcher.prototype=Object.create(null,{on:{value:function(eventNames,handlerFunction,thisObject){var events=eventNames.split(" ");events.forEach(function(eventName){var handlers=this.handlersMap[eventName],isOn=!1;handlers?isOn=handlers.some(function(ref){return ref.handlerFunction===handlerFunction}):handlers=this.handlersMap[eventName]=[],isOn||handlers.push({handlerFunction:handlerFunction,thisObject:thisObject})},this)}},off:{value:function(eventNames,handlerFunction){if(typeof eventNames=="undefined")for(var eventName in this.handlersMap)delete this.handlersMap[eventName];else{var events=eventNames.split(" ");events.forEach(function(eventName){typeof handlerFunction=="undefined"?delete this.handlersMap[eventName]:this.handlersMap[eventName].forEach(function(ref,index,arr){ref.handlerFunction===handlerFunction&&arr.splice(index,1)},this)},this)}}},trigger:{value:function(eventName,args){if(typeof eventName!="undefined"){var handlers=this.handlersMap[eventName];handlers&&handlers.forEach(function(ref){var thisObject=typeof ref.thisObject!="undefined"?ref.thisObject:this;Array.isArray(args)||(args=[args]),ref.handlerFunction.apply(thisObject,args)},this)}}},bind:{value:function(handler,thisObject){return function(){handler.apply(thisObject,Array.prototype.slice.call(arguments))}}}}),EventDispatcher}),define("Component",["EventDispatcher"],function(EventDispatcher){var Component=function(options){EventDispatcher.call(this),this.isTouch="ontouchstart"in window,this.MOUSE_DOWN_EV=this.isTouch?"touchstart":"mousedown",this.MOUSE_MOVE_EV=this.isTouch?"touchmove":"mousemove",this.MOUSE_UP_EV=this.isTouch?"touchend":"mouseup",this.options=options,this.model=options?options.model:null,this.collection=options?options.collection:null,this.setElement(options?options.el:null)};return Component.prototype=Object.create(EventDispatcher.prototype),Component.prototype.setElement=function(el){el||(el="<div/>"),this.$el=$(el),this.el=this.$el[0]},Component.prototype.$=function(selector){return this.$el.find(selector)},Component.prototype.render=function(){return this},Component.prototype.remove=function(){this.off(),this.$el.remove()},Component}),define("EntryBase",["Component"],function(Component){var EntryBase=function(options){Component.call(this,options),this.isTouch||(this.$el.on("click",this.bind(this._clickHandler,this)),this.$el.on("contextmenu",this.bind(this._clickHandler,this))),this.$el.on(this.MOUSE_DOWN_EV,this.bind(this._mouseDownHandler,this))};return EntryBase.prototype=Object.create(Component.prototype,{select:{value:function(){this.$el.addClass("selected")}},unselect:{value:function(){this.$el.removeClass("selected")}},_mouseDownHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation(),this.trigger("focused",this);var that=this,moveTarget=$(document);this._mouseDownHandler.longPress=null,this._mouseDownHandler.longPressTimer=setTimeout(function(){that._mouseDownHandler.longPress==null&&(moveTarget.off(that.MOUSE_MOVE_EV,that._mouseMoveHandler),moveTarget.off(that.MOUSE_UP_EV,that._mouseUpHandler),that._mouseDownHandler.longPress=!0,that.trigger("contextMenu",that))},300);var touchPoint=event.type.indexOf("touch")==0?event.originalEvent.touches[0]:event,elOffset=this.$el.offset();this._mouseDownHandler.touchPoint={x:touchPoint.pageX,y:touchPoint.pageY,offsetX:touchPoint.pageX-elOffset.left,offsetY:touchPoint.pageY-elOffset.top},moveTarget.on(this.MOUSE_MOVE_EV,{context:this},this._mouseMoveHandler),moveTarget.on(this.MOUSE_UP_EV,{context:this},this._mouseUpHandler)}},_mouseMoveHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation();var that=event.data.context,dragEvent;if(that.dragging){dragEvent=that._createDragEvent("dragging",event.originalEvent,that),that.trigger(dragEvent.type,dragEvent);return}var moveTouchPoint=event.type.indexOf("touch")==0?event.originalEvent.touches[0]:event,downTouchPoint=that._mouseDownHandler.touchPoint;that.canDrag&&(Math.abs(downTouchPoint.x-moveTouchPoint.pageX)>20||Math.abs(downTouchPoint.y-moveTouchPoint.pageY)>20)&&(that.dragging=!0,that._mouseDownHandler.longPress=!1,dragEvent=that._createDragEvent("draggingStart",event.originalEvent,that),that.trigger(dragEvent.type,dragEvent))}},_mouseUpHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation();var that=event.data.context;$(event.currentTarget).off(that.MOUSE_MOVE_EV,that._mouseMoveHandler),$(event.currentTarget).off(that.MOUSE_UP_EV,that._mouseUpHandler),clearTimeout(that._mouseDownHandler.longPressTimer);if(that.dragging){that.dragging=!1;var dragEvent=that._createDragEvent("drop",event.originalEvent,that);that.trigger(dragEvent.type,dragEvent)}}},_createDragEvent:{value:function(type,originalEvent,target){var touchPoint;if(originalEvent.type.indexOf("touch")==0)if(originalEvent.touches.length>0)touchPoint=originalEvent.touches[0];else{if(!(originalEvent.changedTouches.length>0))throw new Error("Touch point coordinates are not available!");touchPoint=originalEvent.changedTouches[0]}else touchPoint=originalEvent;return{type:type,target:target,clientX:touchPoint.clientX,clientY:touchPoint.clientY,pageX:touchPoint.pageX,pageY:touchPoint.pageY,screenX:touchPoint.screenX,screenY:touchPoint.screenY,offsetX:this._mouseDownHandler.touchPoint.offsetX,offsetY:this._mouseDownHandler.touchPoint.offsetY}}},_clickHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation(),this.trigger("focused",this),event.button==2&&this.trigger("contextMenu",this)}}}),EntryBase}),define("utils/DateHelper",[],function(){var DateHelper=function(){};DateHelper.SEC_MS=1e3,DateHelper.MINUTE_MS=60*DateHelper.SEC_MS,DateHelper.HOUR_MS=60*DateHelper.MINUTE_MS,DateHelper.DAY_MS=24*DateHelper.HOUR_MS,DateHelper.toISO8601=function(date){var year=date.getUTCFullYear(),month=date.getUTCMonth()+1,day=date.getUTCDate(),hours=date.getHours(),minutes=date.getMinutes(),seconds=date.getSeconds();month=month<10?"0"+month:month,day=day<10?"0"+day:day,hours=hours<10?"0"+hours:hours,minutes=minutes<10?"0"+minutes:minutes,seconds=seconds<10?"0"+seconds:seconds;var tzOffsetSign="-",tzOffset=date.getTimezoneOffset();tzOffset<0&&(tzOffsetSign="+",tzOffset=-tzOffset);var tzOffsetMinutes=tzOffset%60,tzOffsetHours=(tzOffset-tzOffsetMinutes)/60,tzOffsetMinutesStr=tzOffsetMinutes<10?"0"+tzOffsetMinutes:""+tzOffsetMinutes,tzOffsetHoursStr=tzOffsetHours<10?"0"+tzOffsetHours:""+tzOffsetHours;return year+"-"+month+"-"+day+"T"+hours+":"+minutes+":"+seconds+".000"+tzOffsetSign+""+tzOffsetHoursStr+""+tzOffsetMinutesStr},DateHelper.parseISO8601=function(string){if(string==null||string=="")return null;var regexp="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2})([0-9]{2})))?)?)?)?",d=string.match(new RegExp(regexp)),offset=0,date=new Date(d[1],0,1);return d[3]&&date.setMonth(d[3]-1),d[5]&&date.setDate(d[5]),d[7]&&date.setHours(d[7]),d[8]&&date.setMinutes(d[8]),d[10]&&date.setSeconds(d[10]),d[12]&&date.setMilliseconds(Number("0."+d[12])*1e3),d[14]&&(offset=Number(d[16])*60+Number(d[17]),offset=d[15]=="-"?offset:-offset),offset-=date.getTimezoneOffset(),date.setTime(date.getTime()+offset*60*1e3),date};var addDays=DateHelper.addDays=function(date,days){var result=new Date(date);return result.setDate(date.getDate()+days),result},firstDayOfWeek=DateHelper.firstDayOfWeek=function(date){var day=date.getDay();return day=day==0?-6:day-1,addDays(date,-day)},hoursInMs=DateHelper.hoursInMs=function(date){return date.getHours()*60*60*1e3+date.getMinutes()*60*1e3+date.getSeconds()*1e3+date.getMilliseconds()},sameDates=DateHelper.sameDates=function(date1,date2){return date1.getYear()==date2.getYear()&&date1.getMonth()==date2.getMonth()&&date1.getDate()==date2.getDate()},lastDayOfWeek=DateHelper.lastDayOfWeek=function(date){var day=date.getDay();return day==0||(day=7-day),addDays(date,day)},nextWeekFirstDay=DateHelper.nextWeekFirstDay=function(date){return addDays(firstDayOfWeek(date),7)},prevWeekFirstDay=DateHelper.prevWeekFirstDay=function(date){return addDays(firstDayOfWeek(date),-7)},nextMonthFirstDay=DateHelper.nextMonthFirstDay=function(date){var result=new Date(date);return result.setMonth(date.getMonth()+1,1),result},prevMonthFirstDay=DateHelper.prevMonthFirstDay=function(date){var result=new Date(date);return result.setMonth(date.getMonth()-1,1),result},format=DateHelper.format=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){val=String(val),len=len||2;while(val.length<len)val="0"+val;return val};return function(date,mask,utc){var dF=format;arguments.length==1&&Object.prototype.toString.call(date)=="[object String]"&&!/\d/.test(date)&&(mask=date,date=undefined),date=date?new Date(date):new Date;if(isNaN(date))throw SyntaxError("invalid date");mask=String(dF.masks[mask]||mask||dF.masks["default"]),mask.slice(0,4)=="UTC:"&&(mask=mask.slice(4),utc=!0);var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:dF.i18n.dayNames[D],dddd:dF.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:dF.i18n.monthNames[m],mmmm:dF.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:H<12?"a":"p",tt:H<12?"am":"pm",T:H<12?"A":"P",TT:H<12?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1)})}}();return format.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},format.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},DateHelper}),define("text",["module"],function(module){var progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation=typeof location!="undefined"&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||undefined),buildMap=[],masterConfig=module.config(),text,fs;return text={version:"2.0.0",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);matches&&(content=matches[1])}else content="";return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")},createXhr:function(){var xhr,i,progId;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(i=0;i<3;i++){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}return xhr},parseName:function(name){var strip=!1,index=name.indexOf("."),modName=name.substring(0,index),ext=name.substring(index+1,name.length);return index=ext.indexOf("!"),index!==-1&&(strip=ext.substring(index+1,ext.length),strip=strip==="strip",ext=ext.substring(0,index)),{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var match=text.xdRegExp.exec(url),uProtocol,uHostName,uPort;return match?(uProtocol=match[2],uHostName=match[3],uHostName=uHostName.split(":"),uPort=uHostName[1],uHostName=uHostName[0],(!uProtocol||uProtocol===protocol)&&(!uHostName||uHostName===hostname)&&(!uPort&&!uHostName||uPort===port)):!0},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content,masterConfig.isBuild&&(buildMap[name]=content),onLoad(content)},load:function(name,req,onLoad,config){if(config.isBuild&&!config.inlineText){onLoad();return}masterConfig.isBuild=config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+"."+parsed.ext,url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)?text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){onLoad.error&&onLoad.error(err)}):req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)})},write:function(pluginName,moduleName,write,config){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),nonStripName=parsed.moduleName+"."+parsed.ext,fileName=req.toUrl(parsed.moduleName+"."+parsed.ext)+".js";text.load(nonStripName,req,function(value){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)},text.write(pluginName,nonStripName,textWrite,config)},config)}},typeof process!="undefined"&&process.versions&&!!process.versions.node?(fs=require.nodeRequire("fs"),text.get=function(url,callback){var file=fs.readFileSync(url,"utf8");file.indexOf("﻿")===0&&(file=file.substring(1)),callback(file)}):text.createXhr()?text.get=function(url,callback,errback){var xhr=text.createXhr();xhr.open("GET",url,!0),masterConfig.onXhr&&masterConfig.onXhr(xhr,url),xhr.onreadystatechange=function(evt){var status,err;xhr.readyState===4&&(status=xhr.status,status>399&&status<600?(err=new Error(url+" HTTP status: "+status),err.xhr=xhr,errback(err)):callback(xhr.responseText))},xhr.send(null)}:typeof Packages!="undefined"&&(text.get=function(url,callback){var encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),stringBuffer,line,content="";try{stringBuffer=new java.lang.StringBuffer,line=input.readLine(),line&&line.length()&&line.charAt(0)===65279&&(line=line.substring(1)),stringBuffer.append(line);while((line=input.readLine())!==null)stringBuffer.append(lineSeparator),stringBuffer.append(line);content=String(stringBuffer.toString())}finally{input.close()}callback(content)}),text}),define("text!WeekEntry.tpl!strip",[],function(){return'<cj:WeekEntry>\n    <cj:ColorBar></cj:ColorBar>\n    <cj:Content>\n        <cj:Centered>\n            <cj:Label class="week-entry-title"></cj:Label>\n        </cj:Centered>\n    </cj:Content>\n</cj:WeekEntry>\n\n'}),define("WeekEntry",["EntryBase","utils/DateHelper","text!WeekEntry.tpl!strip"],function(EntryBase,DateHelper,WeekEntryTemplate){var WeekEntry=function(options){options.el=WeekEntryTemplate,EntryBase.call(this,options),this.hourHeight=0,this.startDateTime=null,this.endDateTime=null,this.entryTop=0,this.entryBottom=0,this.$colorBar=this.$("cj\\:ColorBar"),this.$titleLabel=this.$("cj\\:Content cj\\:Label"),this.$resizeBarTop=null,this.$resizeBarBottom=null,this.canDrag=!0,this.dragging=!1,this.hourHeight=options.hourHeight,this.startDateTime=options.startDateTime,this.endDateTime=options.endDateTime,this.measure(),this.startDateTime.getTime()==this.model.get("StartDateTime").getTime()?this.$resizeBarTop=$("<cj:Handle />"):this.canDrag=!1,this.endDateTime.getTime()==this.model.get("EndDateTime").getTime()&&(this.$resizeBarBottom=$("<cj:Handle />")),this.renderFn=options.weekEntryRenderFn||this._defaultRender,this.changeFn=options.weekEntryChangeFn||this._defaultRender,this.model.on("change",this._model_changeHandler,this)};return WeekEntry.prototype=Object.create(EntryBase.prototype,{render:{value:function(){return this.renderFn.call(this)}},_defaultRender:{value:function(){return this.$colorBar.css("background-color",this.model.get("Color")),this.$titleLabel.html(this.model.get("Title")),this.$el.css({top:this.entryTop+"px",bottom:this.entryBottom+"px"}),this.$el.hasClass("selected")&&this.select(),this}},_model_changeHandler:{value:function(){this.changeFn.call(this)}},measure:{value:function(){var duration=this.endDateTime.getTime()-this.startDateTime.getTime(),hour=this.startDateTime.getHours()*DateHelper.HOUR_MS+this.startDateTime.getMinutes()*DateHelper.MINUTE_MS+this.startDateTime.getSeconds()*DateHelper.SEC_MS+this.startDateTime.getMilliseconds();this.entryTop=Math.floor(hour/DateHelper.HOUR_MS*this.hourHeight),this.entryBottom=Math.floor((DateHelper.DAY_MS-(hour+duration))/DateHelper.HOUR_MS*this.hourHeight)}},_resizeBar_mouseDownHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation();var that=event.data.context;that.prevPageY=null,that.timeChange=null;var moveTarget=$(document);moveTarget.on(that.MOUSE_MOVE_EV,event.data,that._resizeBar_mouseMoveHandler),moveTarget.on(that.MOUSE_UP_EV,event.data,that._resizeBar_mouseUpHandler)}},_resizeBar_mouseMoveHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation();var that=event.data.context,touchCoords=event.type.indexOf("touch")==0?event.originalEvent.touches[0]:event,offsetY=that.prevPageY?touchCoords.pageY-that.prevPageY:0;that.prevPageY=touchCoords.pageY,that.trigger("barMove",{offsetY:offsetY,bar:event.data.bar,target:that})}},_resizeBar_mouseUpHandler:{value:function(event){event.preventDefault(),event.stopImmediatePropagation();var that=event.data.context;$(event.currentTarget).off(that.MOUSE_MOVE_EV,that._resizeBar_mouseMoveHandler),$(event.currentTarget).off(that.MOUSE_UP_EV,that._resizeBar_mouseUpHandler),that.trigger("barMoveEnd",{bar:event.data.bar,target:that})}},select:{value:function(){EntryBase.prototype.select.call(this),this.$resizeBarTop&&(this.$resizeBarTop.appendTo(this.$el),this.$resizeBarTop.on(this.MOUSE_DOWN_EV,{context:this,bar:"top"},this._resizeBar_mouseDownHandler)),this.$resizeBarBottom&&(this.$resizeBarBottom.appendTo(this.$el),this.$resizeBarBottom.on(this.MOUSE_DOWN_EV,{context:this,bar:"bottom"},this._resizeBar_mouseDownHandler))}},unselect:{value:function(){EntryBase.prototype.unselect.call(this),this.$resizeBarTop&&(this.$resizeBarTop.detach(),this.$resizeBarTop.off(this.MOUSE_DOWN_EV,this._resizeBar_mouseDownHandler)),this.$resizeBarBottom&&(this.$resizeBarBottom.detach(),this.$resizeBarBottom.off(this.MOUSE_DOWN_EV,this._resizeBar_mouseDownHandler))}}}),WeekEntry}),define("text!WeekView.tpl!strip",[],function(){return'<cj:WeekView>\n    <cj:Headers>\n    </cj:Headers>\n    <cj:Scroller>\n        <cj:Container>\n            <cj:LeftHours>\n                <cj:Label class="hour-marker"></cj:Label>\n                <cj:Label class="hour-marker">01 AM</cj:Label>\n                <cj:Label class="hour-marker">02 AM</cj:Label>\n                <cj:Label class="hour-marker">03 AM</cj:Label>\n                <cj:Label class="hour-marker">04 AM</cj:Label>\n                <cj:Label class="hour-marker">05 AM</cj:Label>\n                <cj:Label class="hour-marker">06 AM</cj:Label>\n                <cj:Label class="hour-marker">07 AM</cj:Label>\n                <cj:Label class="hour-marker">08 AM</cj:Label>\n                <cj:Label class="hour-marker">09 AM</cj:Label>\n                <cj:Label class="hour-marker">10 AM</cj:Label>\n                <cj:Label class="hour-marker">11 AM</cj:Label>\n                <cj:Label class="hour-marker">12 PM</cj:Label>\n                <cj:Label class="hour-marker">01 PM</cj:Label>\n                <cj:Label class="hour-marker">02 PM</cj:Label>\n                <cj:Label class="hour-marker">03 PM</cj:Label>\n                <cj:Label class="hour-marker">04 PM</cj:Label>\n                <cj:Label class="hour-marker">05 PM</cj:Label>\n                <cj:Label class="hour-marker">06 PM</cj:Label>\n                <cj:Label class="hour-marker">07 PM</cj:Label>\n                <cj:Label class="hour-marker">08 PM</cj:Label>\n                <cj:Label class="hour-marker">09 PM</cj:Label>\n                <cj:Label class="hour-marker">10 PM</cj:Label>\n                <cj:Label class="hour-marker">11 PM</cj:Label>\n            </cj:LeftHours>\n            <cj:WeekDays>\n            </cj:WeekDays>\n            <cj:RightHours>\n                <cj:Label class="hour-marker"></cj:Label>\n                <cj:Label class="hour-marker">01 AM</cj:Label>\n                <cj:Label class="hour-marker">02 AM</cj:Label>\n                <cj:Label class="hour-marker">03 AM</cj:Label>\n                <cj:Label class="hour-marker">04 AM</cj:Label>\n                <cj:Label class="hour-marker">05 AM</cj:Label>\n                <cj:Label class="hour-marker">06 AM</cj:Label>\n                <cj:Label class="hour-marker">07 AM</cj:Label>\n                <cj:Label class="hour-marker">08 AM</cj:Label>\n                <cj:Label class="hour-marker">09 AM</cj:Label>\n                <cj:Label class="hour-marker">10 AM</cj:Label>\n                <cj:Label class="hour-marker">11 AM</cj:Label>\n                <cj:Label class="hour-marker">12 PM</cj:Label>\n                <cj:Label class="hour-marker">01 PM</cj:Label>\n                <cj:Label class="hour-marker">02 PM</cj:Label>\n                <cj:Label class="hour-marker">03 PM</cj:Label>\n                <cj:Label class="hour-marker">04 PM</cj:Label>\n                <cj:Label class="hour-marker">05 PM</cj:Label>\n                <cj:Label class="hour-marker">06 PM</cj:Label>\n                <cj:Label class="hour-marker">07 PM</cj:Label>\n                <cj:Label class="hour-marker">08 PM</cj:Label>\n                <cj:Label class="hour-marker">09 PM</cj:Label>\n                <cj:Label class="hour-marker">10 PM</cj:Label>\n                <cj:Label class="hour-marker">11 PM</cj:Label>\n            </cj:RightHours>\n        </cj:Container>\n    </cj:Scroller>\n</cj:WeekView>\n\n'}),define("WeekView",["Component","WeekEntry","utils/DateHelper","text!WeekView.tpl!strip","require"],function(Component,WeekEntry,DateHelper,WeekViewTpl,require){var WeekView=function(options){options.el=WeekViewTpl,options.collection||(options.collection=[]),Component.call(this,options),this.$headers=this.$("cj\\:Headers"),this.$scroller=this.$("cj\\:Scroller");if(this.isTouch)if(typeof iScroll!="undefined")this.scroller=new iScroll(this.$scroller[0],{hScrollbar:!1});else{var req=typeof _require!="undefined"?_require:require;if(typeof req!="undefined"){var that=this;req(["iScroll"],function(iScroll){that.scroller=new iScroll(that.$scroller[0],{hScrollbar:!1}),that.scroller.scrollTo(0,-(that.currentScrollHour*that.hourHeight),200)},function(err){alert("iScroll not found, please provide it to scroll CalJS week view on devices!")})}else alert("iScroll not found, please provide it to scroll CalJS week view on devices!")}else this.$headers.addClass("desktop"),this.$scroller.css("overflow-y","scroll");this.$container=this.$("cj\\:Container"),this.$leftHours=this.$("cj\\:LeftHours"),this.$days=this.$("cj\\:WeekDays"),this.$rightHours=this.$("cj\\:RightHours"),this.hourHeight=0,this.currentScrollHour=7.75,this.date=options&&options.date?options.date:new Date,this.nonWorkingHidden=options&&options.nonWorkingHidden?options.nonWorkingHidden:!1,this.nonWorkingDays=options&&options.nonWorkingDays?options.nonWorkingDays:[0,6],this.weekStartDay=options&&options.weekStartDay?options.weekStartDay:1,this.rangeStartDate=null,this.rangeEndDate=null,this.weekDays=[],this.entries=[],this.selectedEvent=null,this.collection.on("add",this._collection_addHandler,this),this.collection.on("remove",this._collection_removeHandler,this),this.collection.on("change",this._collection_changeHandler,this)};return WeekView.prototype=Object.create(Component.prototype,{_collection_addHandler:{value:function(calEvent){this._addCalEvent(calEvent)}},_collection_removeHandler:{value:function(calEvent){this._removeCalEvent(calEvent)}},_collection_changeHandler:{value:function(calEvent){(calEvent.hasChanged("StartDateTime")||calEvent.hasChanged("EndDateTime"))&&this._updateCalEvent(calEvent)}},showDate:{value:function(date){this.date=date,this.updateView()}},next:{value:function(){this._setCurrentScrollHour();var nextDate=new Date(this.rangeStartDate);nextDate.setDate(nextDate.getDate()+7),this.showDate(nextDate),this.trigger("rangeChanged")}},prev:{value:function(){this._setCurrentScrollHour();var prevDate=new Date(this.rangeStartDate);prevDate.setDate(prevDate.getDate()-7),this.showDate(prevDate),this.trigger("rangeChanged")}},toggleNonWorking:{value:function(){this._setCurrentScrollHour(),this.nonWorkingHidden=!this.nonWorkingHidden,this.updateView()}},_setCurrentScrollHour:{value:function(){this.currentScrollHour=-this.$container.position().top/this.hourHeight}},updateView:{value:function(){this._setRangeDates(),this._measure(),this._drawCalendarGrid(),this._addCalEvents(),this.scroller?(this.scroller.enable(),this.scroller.refresh(),this.scroller.scrollTo(0,-(this.currentScrollHour*this.hourHeight),200)):this.$scroller.scrollTop(this.currentScrollHour*this.hourHeight)}},selectEventEntries:{value:function(calEvent){this.entries.forEach(function(entry){calEvent==entry.model?entry.select():entry.model==this.selectedEvent&&entry.unselect()},this),this.selectedEvent=calEvent}},deactivateView:{value:function(){this._setCurrentScrollHour(),this.scroller&&this.scroller.disable()}},_setRangeDates:{value:function(){var weekStartDate=new Date(this.date);weekStartDate.setHours(0,0,0,0),weekStartDate.getDay()<this.weekStartDay?weekStartDate.setDate(weekStartDate.getDate()+(this.weekStartDay-weekStartDate.getDay())-7):weekStartDate.setDate(weekStartDate.getDate()+(this.weekStartDay-weekStartDate.getDay())),this.rangeStartDate=weekStartDate;var weekEndDate=new Date(weekStartDate);weekEndDate.setHours(23,59,59,999),weekEndDate.setDate(weekStartDate.getDate()+6),this.rangeEndDate=weekEndDate}},_measure:{value:function(){var hh=Math.floor(this.$scroller.height()/9.5),hhMod=hh%4;this.hourHeight=hhMod!=0?hh+(4-hhMod):hh}},_drawCalendarGrid:{value:function(){var $header,$day,visibleDaysCount=this.nonWorkingHidden?7-this.nonWorkingDays.length:7,dayWidth=Math.floor(100/visibleDaysCount),firstDayMargin=(100-visibleDaysCount*dayWidth)/2,day=this.rangeStartDate,now=new Date,headers=[],days=[];this.weekDays.length=0;for(var i=0;i<7;i++){if(this.nonWorkingHidden&&this.nonWorkingDays.indexOf(day.getDay())>=0)continue;$header=$("<cj:WeekDayHeader><cj:Label>"+DateHelper.format(day,"d")+"</cj:Label><cj:Label>"+DateHelper.format(day,"ddd")+"</cj:Label></cj:WeekDayHeader>").css("width",dayWidth+"%"),$day=$("<cj:WeekDay/>").css({"background-size":"100% "+this.hourHeight+"px",width:dayWidth+"%",height:this.hourHeight*24}),i==0&&($day.css("margin-left",firstDayMargin+"%"),$header.css("margin-left",firstDayMargin+"%")),day.getYear()==now.getYear()&&day.getMonth()==now.getMonth()&&day.getDate()==now.getDate()&&($day.addClass("today"),$header.addClass("today")),this.nonWorkingDays.indexOf(day.getDay())>=0&&($day.addClass("non-working"),$header.addClass("non-working")),headers.push($header[0]),days.push($day[0]),this.weekDays.push(day),day=DateHelper.addDays(day,1)}this.$container.height(this.hourHeight*24+3),this.$headers.length>0&&this.$headers.empty(),headers.length>0&&this.$headers.append(headers),this.$days.length>0&&this.$days.empty(),days.length>0&&this.$days.append(days)}},_addCalEvents:{value:function(){this.entries.forEach(this._removeEntryEventHandlers,this),this.entries.length=0,this.collection.forEach(this._addCalEvent,this)}},_addCalEvent:{value:function(calEvent){var weekStartMs=this.rangeStartDate.getTime(),weekEndMs=this.rangeEndDate.getTime(),entryStartTime=new Date(calEvent.get("StartDateTime")),entryStartTimeMs=entryStartTime.getTime(),entryEndTime=new Date(calEvent.get("EndDateTime")),entryEndTimeMs=entryEndTime.getTime();if(entryStartTimeMs>=weekStartMs&&entryStartTimeMs<=weekEndMs||entryEndTimeMs>=weekStartMs&&entryEndTimeMs<=weekEndMs){var dayEntries={};while(entryStartTimeMs<=entryEndTimeMs){DateHelper.sameDates(entryStartTime,entryEndTime)||(entryEndTime=new Date(entryStartTime),entryEndTime.setHours(23,59,59,999));if(entryStartTimeMs>=weekStartMs&&entryStartTimeMs<=weekEndMs&&!(this.nonWorkingDays.indexOf(entryStartTime.getDay())>=0&&this.nonWorkingHidden)){var entry=new WeekEntry({model:calEvent,hourHeight:this.hourHeight,startDateTime:entryStartTime,endDateTime:entryEndTime,weekEntryRenderFn:this.options.weekEntryRenderFn,weekEntryChangeFn:this.options.weekEntryChangeFn});entry.on("focused",this._entry_focusedHandler,this),entry.on("contextMenu",this._entry_contextMenuHandler,this),entry.on("barMove",this._entry_barMoveHandler,this),entry.on("barMoveEnd",this._entry_barMoveEndHandler,this),entry.on("draggingStart",this._entry_draggingStartHandler,this),entry.on("dragging",this._entry_draggingHandler,this),entry.on("drop",this._entry_dropHandler,this);var entryDay=entryStartTime.getDay();entryDay==0?entryDay=6:entryDay--,dayEntries.hasOwnProperty(entryDay)||(dayEntries[entryDay]=[]),dayEntries[entryDay].push(entry.render().el),this.entries.push(entry)}entryStartTime=new Date(entryStartTime),entryStartTime.setTime(entryStartTime.getTime()+DateHelper.DAY_MS),entryStartTime.setHours(0,0,0,0),entryStartTimeMs=entryStartTime.getTime(),entryEndTime=new Date(calEvent.get("EndDateTime"))}for(var day in dayEntries)$(this.$days.children()[day]).append(dayEntries[day]);calEvent==this.selectedEvent&&this.selectEventEntries(calEvent)}}},_updateCalEvent:{value:function(calEvent){this._removeCalEvent(calEvent),this._addCalEvent(calEvent)}},_removeCalEvent:{value:function(calEvent){this.entries=this.entries.filter(function(entry){var remove=entry.model==calEvent;return remove&&this._removeEntryEventHandlers(entry),!remove},this)}},_removeEntryEventHandlers:{value:function(entry){entry.off("focused",this._entry_focusedHandler),entry.off("contextMenu",this._entry_contextMenuHandler),entry.off("barMove",this._entry_barMoveHandler),entry.off("barMoveEnd",this._entry_barMoveEndHandler),entry.dragging||(entry.off("draggingStart",this._entry_draggingStartHandler),entry.off("dragging",this._entry_draggingHandler),entry.off("drop",this._entry_dropHandler),entry.remove())}},_entry_draggingStartHandler:{value:function(event){var entryModel=event.target.model,height=(entryModel.get("EndDateTime").getTime()-entryModel.get("StartDateTime").getTime())/DateHelper.HOUR_MS*this.hourHeight,ghostEntry=this._entry_draggingStartHandler.ghostEntry=event.target.$el.clone();ghostEntry.css({width:$(this.$days.children()[0]).width(),top:"none",bottom:"none",height:height,opacity:.7}),ghostEntry.appendTo(this.$scroller),ghostEntry.offset({left:event.pageX-event.offsetX,top:event.pageY-event.offsetY})}},_entry_draggingHandler:{value:function(event){var daysOffset=this.$days.offset(),dayWidth=this.$days.children().width(),daysWidth=dayWidth*this.$days.children().length,left=event.pageX-event.offsetX,top=event.pageY-event.offsetY;if(event.pageX>=daysOffset.left&&event.pageX<=daysOffset.left+daysWidth){var dayNum=Math.floor((event.pageX-daysOffset.left)/dayWidth),$day=$(this.$days.children()[dayNum]),dayOffset=$day.offset(),dayMid=dayOffset.left+dayWidth/2,deviation=(event.pageX-dayMid)/dayWidth;left=dayOffset.left+dayWidth*.2*deviation,top<dayOffset.top&&(top=dayOffset.top),this._drawTimeChangeMarkers({time:this._getNearestTime(top-dayOffset.top)}),this._entry_draggingHandler.weekChanged=!1}else this._entry_draggingHandler.weekChanged||(event.target.$el.hide(),event.target.$el.appendTo(this.$scroller),event.pageX<daysOffset.left?this.prev():this.next(),this._entry_draggingHandler.weekChanged=!0);var ghostEntry=this._entry_draggingStartHandler.ghostEntry;ghostEntry.offset({left:left,top:top})}},_entry_dropHandler:{value:function(event){var ghostEntry=this._entry_draggingStartHandler.ghostEntry;ghostEntry.remove(),this._entry_draggingStartHandler.ghostEntry=null,this._clearTimeChangeMarkers();var daysOffset=this.$days.offset(),dayWidth=this.$days.children().width(),daysWidth=dayWidth*this.$days.children().length;if(event.pageX>=daysOffset.left&&event.pageX<=daysOffset.left+daysWidth){var top=event.pageY-event.offsetY,dayNum=Math.floor((event.pageX-daysOffset.left)/dayWidth),$day=$(this.$days.children()[dayNum]),dayOffset=$day.offset(),day=this.weekDays[dayNum];top<dayOffset.top&&(top=dayOffset.top);var snappedStartTime=this._getNearestTime(top-dayOffset.top),calEvent=event.target.model,startDateTime=calEvent.get("StartDateTime"),endDateTime=calEvent.get("EndDateTime"),duration=endDateTime.getTime()-startDateTime.getTime(),newStartDateTime,newEndDateTime;newStartDateTime=new Date(day),newStartDateTime.setHours(snappedStartTime.getHours(),snappedStartTime.getMinutes(),snappedStartTime.getSeconds(),snappedStartTime.getMilliseconds()),newEndDateTime=new Date(newStartDateTime.getTime()+duration),calEvent.set({StartDateTime:newStartDateTime,EndDateTime:newEndDateTime})}this.$el.width()}},_entry_focusedHandler:{value:function(entry){this.selectEventEntries(entry.model)}},_drawTimeChangeMarkers:{value:function(changeInfo){var $markers=arguments.callee.markers;arguments.callee.markers=null,$markers&&$markers.hasClass("hour-marker")?$markers.css("font-weight",""):$markers&&$markers.hasClass("minutes-marker")&&$markers.remove();if(changeInfo.time.getMinutes()==0||changeInfo.time.getMinutes()==59){var labelIndex=changeInfo.time.getMinutes()==59?24:changeInfo.time.getHours();labelIndex!=0&&labelIndex!=24&&($markers=$(this.$leftHours.children()[labelIndex]),$markers=$markers.add(this.$rightHours.children()[labelIndex]),$markers.css("font-weight","bold"))}else $markers=$('<cj:Label class="minutes-marker"/>'),$markers=$markers.add($markers.clone()),this.$leftHours.append($markers[0]),this.$rightHours.append($markers[1]),$markers.html(DateHelper.format(changeInfo.time,":MM")),$markers.css("top",(changeInfo.time.getHours()+changeInfo.time.getMinutes()/60)*this.hourHeight+"px");arguments.callee.markers=$markers}},_clearTimeChangeMarkers:{value:function(){var $markers=this._drawTimeChangeMarkers.markers;$markers&&(this._drawTimeChangeMarkers.markers=null,$markers.hasClass("hour-marker")?$markers.css("font-weight","normal"):$markers.hasClass("minutes-marker")&&$markers.remove())}},_entry_barMoveHandler:{value:function(event){var offsetY=event.offsetY,entry=event.target;if(offsetY!=0){var newHeight=DateHelper.DAY_MS-(entry.entryTop+entry.entryBottom)+offsetY,timeChange;if(event.bar=="bottom"){var newBottom=entry.entryBottom-offsetY;newBottom>=0&&newBottom+this.hourHeight/2<=24*this.hourHeight-entry.entryTop&&(entry.entryBottom=newBottom,entry.$el.css({bottom:entry.entryBottom+"px"}),timeChange=this._getSnappedTime(event.bar,entry))}else{var newTop=entry.entryTop+offsetY;newTop>=0&&newTop+this.hourHeight/2<=24*this.hourHeight-entry.entryBottom&&(entry.entryTop=newTop,entry.$el.css({top:entry.entryTop+"px"}),timeChange=this._getSnappedTime(event.bar,entry))}timeChange&&((!arguments.callee.timeChange||timeChange.getTime()!=arguments.callee.timeChange.getTime())&&this._drawTimeChangeMarkers({time:timeChange,bar:event.bar,target:entry}),arguments.callee.timeChange=timeChange)}}},_entry_barMoveEndHandler:{value:function(event){console.log("");var entry=event.target,snappedTime=this._getSnappedTime(event.bar,entry),modelUpdate;event.bar=="bottom"?(entry.endDateTime=snappedTime,modelUpdate={EndDateTime:snappedTime}):(entry.startDateTime=snappedTime,modelUpdate={StartDateTime:snappedTime}),entry.measure(),entry.$el.css({top:entry.entryTop+"px",bottom:entry.entryBottom+"px"}),entry.model.set(modelUpdate),this._clearTimeChangeMarkers()}},_getSnappedTime:{value:function(bar,entry){var that=entry,startingDateTime=bar=="bottom"?that.endDateTime:that.startDateTime,startingPosition=bar=="bottom"?24*that.hourHeight-that.entryBottom:that.entryTop,snappedHour=this._getNearestTime(startingPosition),result=new Date(startingDateTime);return result.setHours(snappedHour.getHours(),snappedHour.getMinutes(),snappedHour.getSeconds(),snappedHour.getMilliseconds()),result}},_getNearestTime:{value:function(from){var that=this,hour=from/that.hourHeight*DateHelper.HOUR_MS,modMs=hour%(DateHelper.HOUR_MS*.25);modMs>7.5*DateHelper.MINUTE_MS?hour=hour-modMs+15*DateHelper.MINUTE_MS:hour-=modMs;var result=new Date(hour);return result.setHours(result.getUTCHours(),result.getUTCMinutes(),result.getUTCMinutes(),result.getUTCMilliseconds()),result.getMonth()>1?result.setTime(0):result.getDate()>1&&result.setTime(result.getTime()-1),result}},_entry_contextMenuHandler:{value:function(entry){this.trigger("contextMenu",entry)}}}),WeekView}),define("text!MonthEntry.tpl!strip",[],function(){return'<cj:MonthEntry>\n    <cj:ColorBar/>\n    <cj:Content>\n        <cj:Label class="month-entry-title"></cj:Label>\n        <cj:Label class="month-entry-start-time"></cj:Label>\n    </cj:Content>\n</cj:MonthEntry>\n\n'}),define("MonthEntry",["EntryBase","utils/DateHelper","text!MonthEntry.tpl!strip"],function(EntryBase,DateHelper,MonthEntryTemplate){var MonthEntry=function(options){options.el=MonthEntryTemplate,EntryBase.call(this,options),this.$colorBar=this.$("cj\\:ColorBar"),this.$titleLabel=this.$("cj\\:Label.month-entry-title"),this.$startTime=this.$("cj\\:Label.month-entry-start-time"),this.renderFn=options.monthEntryRenderFn||this._defaultRender,this.changeFn=options.monthEntryChangeFn||this._defaultRender,this.model.on("change",this._model_changeHandler,this)};return MonthEntry.prototype=Object.create(EntryBase.prototype,{render:{value:function(){return this.renderFn.call(this)}},_defaultRender:{value:function(){return this.$colorBar.css("background-color",this.model.get("Color")),this.$titleLabel.html(this.model.get("Title")),this.$startTime.html(DateHelper.format(this.model.get("StartDateTime"),"HH:MM TT")),this}},_model_changeHandler:{value:function(){this.changeFn.call(this)}}}),MonthEntry}),define("MonthView",["Component","MonthEntry","utils/DateHelper"],function(Component,MonthEntry,DateHelper){var MonthView=function(options){options.el="<cj:MonthView/>",options.collection||(options.collection=[]),Component.call(this,options),this.date=options.date?options.date:new Date,this.nonWorkingHidden=options.nonWorkingHidden?options.nonWorkingHidden:!1,this.nonWorkingDays=options.nonWorkingDays?options.nonWorkingDays:[0,6],this.weekStartDay=options.weekStartDay?options.weekStartDay:1,this.rangeStartDate=null,this.rangeEndDate=null,this.days={},this.entries=[],this.selectedEvent=null,this.collection.on("add",this._collection_addHandler,this),this.collection.on("remove",this._collection_removeHandler,this),this.collection.on("change",this._collection_changeHandler,this)};return MonthView.prototype=Object.create(Component.prototype,{_collection_addHandler:{value:function(calEvent){this._addCalEvent(calEvent)}},_collection_removeHandler:{value:function(calEvent){this._removeCalEvent(calEvent)}},_collection_changeHandler:{value:function(calEvent){(calEvent.hasChanged("StartDateTime")||calEvent.hasChanged("EndDateTime"))&&this._updateCalEvent(calEvent)}},showDate:{value:function(date){this.date=date,this.updateView()}},next:{value:function(){var nextDate=new Date(this.date);nextDate.setDate(1),nextDate.setMonth(nextDate.getMonth()+1),this.showDate(nextDate),this.trigger("rangeChanged")}},prev:{value:function(){var nextDate=new Date(this.date);nextDate.setDate(1),nextDate.setMonth(nextDate.getMonth()-1),this.showDate(nextDate),this.trigger("rangeChanged")}},toggleNonWorking:{value:function(){this.nonWorkingHidden=!this.nonWorkingHidden,this.updateView()}},updateView:{value:function(){this._setRangeDates(),this._drawCalendarGrid(),this._addCalEvents()}},_setRangeDates:{value:function(){var monthStartDate=new Date(this.date);monthStartDate.setDate(1),monthStartDate.setHours(0,0,0,0),monthStartDate.getDay()<this.weekStartDay?monthStartDate.setDate(monthStartDate.getDate()+(this.weekStartDay-monthStartDate.getDay())-7):monthStartDate.setDate(monthStartDate.getDate()+(this.weekStartDay-monthStartDate.getDay())),this.rangeStartDate=monthStartDate;var monthEndDate=new Date(this.date);monthEndDate.setHours(0,0,0,0),monthEndDate.setMonth(monthEndDate.getMonth()+1),monthEndDate.setDate(1),monthEndDate.setTime(monthEndDate.getTime()-1);var weekEndDay=this.weekStartDay==1?0:this.weekStartDay-1;monthEndDate.getDay()!=weekEndDay&&(weekEndDay==0?monthEndDate.setDate(monthEndDate.getDate()+(7-monthEndDate.getDay())):monthEndDate.setDate(monthEndDate.getDate()+(7-(monthEndDate.getDay()+(7-weekEndDay))))),this.rangeEndDate=monthEndDate}},_drawCalendarGrid:{value:function(){delete this.days,this.days={};var cellDate=new Date(this.rangeStartDate),today=new Date,$week,$day,$weeks,columnWidth=this.nonWorkingHidden?100/(7-this.nonWorkingDays.length):100/7;while(cellDate.getTime()<this.rangeEndDate.getTime()){if(!this.nonWorkingHidden||this.nonWorkingHidden&&this.nonWorkingDays.indexOf(cellDate.getDay())==-1){this.weekStartDay==cellDate.getDay()&&($week=$("<cj:MonthWeek/>"),$weeks?$weeks=$weeks.add($week):$weeks=$week);var labelFormat=$weeks.length==1?"ddd. dd":"dd",isCurrentMonth=this.date.getMonth()==cellDate.getMonth(),isToday=DateHelper.sameDates(cellDate,today);$day=$("<cj:MonthDay/>").attr({style:"width: "+columnWidth+"%",current:isCurrentMonth,today:isToday}),$day.html($("<cj:MonthDayLabel />").html(DateHelper.format(cellDate,labelFormat))),$week.append($day),this.days[cellDate.getTime()]=$day}cellDate.setDate(cellDate.getDate()+1)}this.$el.empty(),$weeks.attr("style","height: "+100/$weeks.length+"%"),this.$el.append($weeks.toArray())}},_addCalEvents:{value:function(){this.entries.forEach(this._removeEntryEventHandlers,this),this.entries.length=0,this.collection.forEach(this._addCalEvent,this)}},_addCalEvent:{value:function(calEvent){var rangeStartMs=this.rangeStartDate.getTime(),rangeEndMs=this.rangeEndDate.getTime(),entryStartTime=new Date(calEvent.get("StartDateTime")),entryStartTimeMs=entryStartTime.getTime(),entryEndTime=new Date(calEvent.get("EndDateTime")),entryEndTimeMs=entryEndTime.getTime();if(entryStartTimeMs>=rangeStartMs&&entryStartTimeMs<=rangeEndMs||entryEndTimeMs>=rangeStartMs&&entryEndTimeMs<=rangeEndMs){var dayEntries={};while(entryStartTimeMs<=entryEndTimeMs){if(entryStartTimeMs>=rangeStartMs&&entryStartTimeMs<=rangeEndMs&&!(this.nonWorkingDays.indexOf(entryStartTime.getDay())>=0&&this.nonWorkingHidden)){var entryDate=new Date(entryStartTime);entryDate.setHours(0,0,0,0);var entry=new MonthEntry({model:calEvent,date:entryDate,monthEntryRenderFn:this.options.monthEntryRenderFn,monthEntryChangeFn:this.options.monthEntryChangeFn});entry.on("focused",this._entry_focusedHandler,this),entry.on("contextMenu",this._entry_contextMenuHandler,this),dayEntries.hasOwnProperty(entryDate.getTime())||(dayEntries[entryDate.getTime()]=[]),dayEntries[entryDate.getTime()].push(entry.render().el),this.entries.push(entry)}entryStartTime=new Date(entryStartTime),entryStartTime.setHours(0,0,0,0),entryStartTime.setDate(entryStartTime.getDate()+1),entryStartTimeMs=entryStartTime.getTime()}for(var day in dayEntries)this.days[day].append(dayEntries[day]);calEvent==this.selectedEvent&&this.selectEventEntries(calEvent)}}},_updateCalEvent:{value:function(calEvent){this._removeCalEvent(calEvent),this._addCalEvent(calEvent)}},_removeCalEvent:{value:function(calEvent){this.entries=this.entries.filter(function(entry){var remove=entry.model==calEvent;return remove&&this._removeEntryEventHandlers(entry),!remove},this)}},_removeEntryEventHandlers:{value:function(entry){entry.off("focused",this._entry_focusedHandler),entry.off("contextMenu",this._entry_contextMenuHandler),entry.remove()}},_entry_focusedHandler:{value:function(entry){this.selectEventEntries(entry.model)}},selectEventEntries:{value:function(calEvent){this.entries.forEach(function(entry){calEvent==entry.model?entry.select():entry.model==this.selectedEvent&&entry.unselect()},this),this.selectedEvent=calEvent}},_entry_contextMenuHandler:{value:function(entry){this.trigger("contextMenu",entry)}}}),MonthView}),define("text!Calendar.tpl!strip",[],function(){return'<cj:Calendar xmlns:cj="http://caljs.org/1.0">\n    <cj:NavigationBar>\n        <cj:NavigationBarLeft>\n            <cj:Button class="btn-prev up"/>\n            <cj:RangeLabel/>\n        </cj:NavigationBarLeft>\n\n        <cj:NavigationBarRight>\n            <cj:Button class="btn-toggle-non-working txt up">Toggle Sat/Sun</cj:Button>\n            <cj:Button class="btn-week-view down" name="cal-views"/>\n            <cj:Button class="btn-month-view up" name="cal-views"/>\n            <cj:Button class="btn-next up"/>\n        </cj:NavigationBarRight>\n    </cj:NavigationBar>\n</cj:Calendar>'}),define("utils/TouchButtons",[],function(){var isTouch="ontouchstart"in window,MOUSE_DOWN=isTouch?"touchstart":"mousedown",MOUSE_UP=isTouch?"touchend":"mouseup";$(document).on(MOUSE_DOWN,"cj\\:Button",function(event){event.preventDefault(),event.stopImmediatePropagation();var el=this,$el=$(el);if(isTouch&&event.originalEvent.touches.length==1||!isTouch&&event.which==1)$el.addClass("active"),$(document).on(MOUSE_UP,function(event){event.preventDefault(),event.stopImmediatePropagation(),$(document).off(MOUSE_UP,arguments.callee),$el.removeClass("active");var groupName=$el.attr("name"),groupButtons=groupName?$("cj\\:Button[name='"+groupName+"']"):null;if(groupButtons)if(groupButtons.length>1){var wasUp=!1;groupButtons.each(function(){if(this==el)$el.hasClass("up")&&($el.removeClass("up"),wasUp=!0),$el.hasClass("down")||$el.addClass("down");else{var $grpBtn=$(this);$grpBtn.hasClass("down")&&$grpBtn.removeClass("down"),$grpBtn.hasClass("up")||$grpBtn.addClass("up")}}),wasUp&&$el.trigger("tbclick")}else $el.hasClass("down")?$el.removeClass("down").addClass("up"):$el.removeClass("up").addClass("down"),$el.trigger("tbclick");else $el.trigger("tbclick")})})}),define("Calendar",["Component","WeekView","MonthView","text!Calendar.tpl!strip","utils/DateHelper","utils/TouchButtons"],function(Component,WeekView,MonthView,CalendarTpl,DateHelper){var Calendar=function(options){this.RESIZE_EV="onorientationchange"in window?"orientationchange":"resize",options||(options={el:"<div/>"}),Component.call(this,options),this.weekView=null,this.monthView=null,this.currentView=null,this.date=options&&options.date?options.date:new Date,this.windowHeight=null};return Calendar.RANGE_CHANGED="rangeChanged",Calendar.CONTEXT_MENU="contextMenu",Calendar.prototype=Object.create(Component.prototype,{render:{value:function(){return this.$calendar=$(CalendarTpl),this.$calendar.on("tbclick","cj\\:Button.btn-prev",this.bind(this._prevBtn_clickHandler,this)),this.$calendar.on("tbclick","cj\\:Button.btn-next",this.bind(this._nextBtn_clickHandler,this)),this.$calendar.on("tbclick","cj\\:Button.btn-week-view",this.bind(this._weekBtn_clickHandler,this)),this.$calendar.on("tbclick","cj\\:Button.btn-month-view",this.bind(this._monthBtn_clickHandler,this)),this.$calendar.on("tbclick","cj\\:Button.btn-toggle-non-working",this.bind(this._toggleBtn_clickHandler,this)),this.weekView=this.currentView=new WeekView({collection:this.collection,date:this.date,weekEntryRenderFn:this.options.weekEntryRenderFn,weekEntryChangeFn:this.options.weekEntryChangeFn}),this.weekView.on(Calendar.RANGE_CHANGED,this._currentView_rangeChangedHandler,this),this.weekView.on(Calendar.CONTEXT_MENU,this._currentView_contextMenuHandler,this),this.weekView.$el.on(this.MOUSE_DOWN_EV,this.bind(this._container_mouseDownHandler,this)),this.$calendar.append(this.currentView.el),this.currentView.render(),this._updateCurrentPeriodLabel(),this.$el.html(this.$calendar),this}},activate:{value:function(){this.windowHeight=window.innerHeight,$(window).on(this.RESIZE_EV,{context:this},this._resize),this.currentView.updateView()}},deactivate:{value:function(){$(window).off(this.RESIZE_EV,this._resize),this.currentView.deactivateView()}},_resize:{value:function(event){var that=event.data.context;that.windowHeight!=window.innerHeight&&that.currentView.updateView.call(that.currentView),that.windowHeight=window.innerHeight}},_weekBtn_clickHandler:{value:function(){this.currentView!=this.weekView&&(this.currentView.$el.detach(),this.currentView=this.weekView,this.$calendar.append(this.currentView.el),this.currentView.showDate(this.date),this.trigger("viewChanged",{viewName:"WeekView"}))}},_monthBtn_clickHandler:{value:function(){this.currentView!=this.monthView&&(this.monthView||(this.monthView=new MonthView({collection:this.collection,date:this.date,monthEntryRenderFn:this.options.monthEntryRenderFn,monthEntryChangeFn:this.options.monthEntryChangeFn}),this.monthView.on(Calendar.RANGE_CHANGED,this._currentView_rangeChangedHandler,this),this.monthView.on(Calendar.CONTEXT_MENU,this._currentView_contextMenuHandler,this),this.monthView.$el.on(this.MOUSE_DOWN_EV,{context:this},this._container_mouseDownHandler),this.monthView.render()),this.currentView.$el.detach(),this.currentView=this.monthView,this.$calendar.append(this.currentView.el),this.currentView.showDate(this.date),this.trigger("viewChanged",{viewName:"MonthView"}))}},_prevBtn_clickHandler:{value:function(){this.currentView.prev()}},_nextBtn_clickHandler:{value:function(){this.currentView.next()}},_updateCurrentPeriodLabel:{value:function(){var label;if(this.currentView instanceof WeekView){var weekStart=DateHelper.firstDayOfWeek(this.currentView.date),weekEnd=DateHelper.lastDayOfWeek(this.currentView.date);weekStart.getMonth()==weekEnd.getMonth()?label=DateHelper.format(weekStart,"mmmm yyyy"):label=DateHelper.format(weekStart,"mmmm")+" - "+DateHelper.format(weekEnd,"mmmm yyyy")}else label=DateHelper.format(this.currentView.date,"mmmm yyyy");this.$calendar.find("cj\\:RangeLabel").html(label)}},_showRangeChangeMessage:{value:function(){var messageText=DateHelper.format(this.currentView.rangeStartDate,"mmm d")+" - "+DateHelper.format(this.currentView.rangeEndDate,"mmm d"),message=$("<cj:RangeChangeMessage/>").html(messageText).appendTo(this.$calendar),messagePosition={top:this.$calendar.height()/2-message.height()/2,left:this.$calendar.width()/2-message.width()/2};message.css(messagePosition).fadeIn(300,function(){$(this).delay(500).fadeOut(300,function(){$(this).remove()})})}},_toggleBtn_clickHandler:{value:function(){this.currentView.toggleNonWorking()}},_currentView_rangeChangedHandler:{value:function(){this.date=this.currentView.date,this._showRangeChangeMessage(),this._updateCurrentPeriodLabel()}},_currentView_contextMenuHandler:{value:function(entry){this.trigger(Calendar.CONTEXT_MENU,entry)}},_container_mouseDownHandler:{value:function(event){var that=this,touchPoint=event.type.indexOf("touch")==0?event.originalEvent.touches[0]:event,touchesCount=event.type.indexOf("touch")==0?event.originalEvent.touches.length:1;this._container_mouseDownHandler.touchPoint={x:touchPoint.pageX,y:touchPoint.pageY};if(touchesCount==1){var moveTarget=$(document);moveTarget.on(that.MOUSE_MOVE_EV,{context:that},this._container_mouseMoveHandler),moveTarget.on(that.MOUSE_UP_EV,{context:that},this._container_mouseUpHandler)}}},_container_mouseMoveHandler:{value:function(event){var that=event.data.context,downTouchPoint=that._container_mouseDownHandler.touchPoint,moveTouchPoint=event.type.indexOf("touch")==0?event.originalEvent.touches[0]:event,touchesCount=event.type.indexOf("touch")==0?event.originalEvent.touches.length:1,xDelta=moveTouchPoint.pageX-downTouchPoint.x,yDelta=moveTouchPoint.pageY-downTouchPoint.y;if(Math.abs(xDelta)>=60&&Math.abs(yDelta)<10&&touchesCount==1){event.preventDefault(),event.stopImmediatePropagation();var moveTarget=$(document);moveTarget.off(that.MOUSE_UP_EV,that._container_mouseUpHandler),moveTarget.off(that.MOUSE_MOVE_EV,that._container_mouseMoveHandler),xDelta>0?that.currentView.prev():xDelta<0&&that.currentView.next()}}},_container_mouseUpHandler:{value:function(event){var that=event.data.context,moveTarget=$(document);moveTarget.off(that.MOUSE_UP_EV,that._container_mouseUpHandler),moveTarget.off(that.MOUSE_MOVE_EV,that._container_mouseMoveHandler);var upTouchPoint=event.type.indexOf("touch")==0?event.originalEvent.changedTouches[0]:event,downTouchPoint=that._container_mouseDownHandler.touchPoint;Math.abs(upTouchPoint.pageX-downTouchPoint.x)<5&&Math.abs(upTouchPoint.pageY-downTouchPoint.y)<5&&(event.preventDefault(),event.stopImmediatePropagation(),that.currentView.selectEventEntries(null),that.currentView.$el.width())}}}),Calendar}),define("Model",["EventDispatcher"],function(EventDispatcher){var Model=function(properties){EventDispatcher.call(this),this.changes=[],this.properties=properties?properties:{}};return Model.prototype=Object.create(EventDispatcher.prototype,{set:{value:function(name,value){this.changes.length=0;if(typeof name=="string")this.properties[name]=value,this.changes.push(name);else for(var key in name)this.properties[key]=name[key],this.changes.push(key);this.trigger("change",this)}},get:{value:function(name){return this.properties[name]}},hasChanged:{value:function(attribute){return this.changes.indexOf(attribute)>=0}}}),Model}),define("Collection",["EventDispatcher","Model"],function(EventDispatcher,Model){var Collection=function(arr){EventDispatcher.call(this),this.arr=[],arr&&arr.forEach(function(item){this._add(item,!0)},this)};return Collection.prototype=Object.create(EventDispatcher.prototype,{_add:{value:function(val,silent){var item=val instanceof Model?val:new Model(val);item.on("change",this._item_changeHandler,this),this.arr.push(item),silent||this.trigger("add",item)}},_item_changeHandler:{value:function(item){this.trigger("change",item)}},forEach:{value:function(iterator,thisObject){this.arr.forEach(iterator,thisObject)}},add:{value:function(models){Array.isArray(models)?models.forEach(function(item){this._add(item)},this):this._add(models)}},remove:{value:function(models){}}}),Collection}),{Calendar:require("Calendar"),Model:require("Model"),Collection:require("Collection")}})